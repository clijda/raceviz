!function(){"use strict";function t(t){return function(e){return e[t]}}function e(t){return t.split(":").map(Number).reduce(function(t,e){return 60*t+e})}function n(t){var e=Math.floor(t/3600),n=Math.floor(t/60-60*e),a=t%60;return e?e+":"+r(n)+":"+r(a):r(n)+":"+r(a)}function a(t){var e=Math.floor(t/3600),n=Math.floor(t/60-60*e);return e+":"+r(n)}function r(t){return t=Math.round(t),10>t?"0"+t:""+t}function i(t){return Math.round(10*t)/10}function l(t){var n=d3.range(1,7).map(function(n){var a=e(t["leg"+n]),r=1===n?0:e(t["leg"+(n-1)]);return a-r}),a=n.reduce(function(t,e){return t.concat([e+t[t.length-1]])},[0]);return n=n.map(function(t,e){return{split:t,start:a[e],end:t+a[e]}}),{name:t.name,legs:n,totalTime:n[n.length-1].end,cumulative:a}}var o=500,c=15,s=10,d={top:0,bottom:10,left:0,right:50},u={top:10,bottom:5,left:30,right:30},p=40,g=60,f=170,m=[4.7,3.7,4.4,4.7,3.7,4.4],h=m.reduce(function(t,e){return t.concat([e+t[t.length-1]])},[0]),v=h[h.length-1],y=d3.select("#top").append("svg").attr("width",o+d.left+d.top).attr("height",p),x=d3.select("#grid").append("svg").attr("width",o+d.left+d.top),b=x.append("g").attr("transform","traslate("+d.left+", "+d.top+")"),k=d3.scale.ordinal();d3.svg.axis().scale(k).orient("left").tickSize(-o,0).tickPadding(30);var T=d3.select("#bottom").append("svg").attr("width",o).attr("height",g).attr("dy",5),A=T.append("g").attr("transform","translate("+(f-u.left)+",0)");d3.select(".bottom.author").style("margin-left",f-u.left+"px"),A.append("rect").attr("width",o-f+u.left).attr("height",g).attr("rx","10").attr("ry","10").attr("fill","lightGray");var w=T.append("image").attr("class","play").attr("width",g).attr("height",g).attr("xlink:href",RACEVIZ.start_img),M=T.append("image").attr("class","pause").attr("width",g).attr("height",g).attr("xlink:href",RACEVIZ.stop_img);d3.csv(RACEVIZ.datafile||"data.csv",l,function(e){function r(t){t.attr("transform",function(t,e){return"translate(0, "+Y(e)+")"})}function l(){return H.style("visibility","hidden")}function k(t,e){return H.html(["Leg "+(e+1),m[e]+"mi",n(t.split/m[e])+"/mi"].join("<br>")),H.style("visibility","visible")}function T(t){t.append("g").selectAll("line.leg-line").data(h).enter().append("line").attr("class","leg-line").attr("x1",B).attr("x2",B).attr("y1",0).attr("y2",X)}function R(){q.sort(function(t,e){return d3.ascending(t.totalTime,e.totalTime)}).call(r),O.classed("active",function(t){return t===h.length}),I()}function z(t,n){U=Q===n?-U:1,Q=n,W=function(){q.sort(function(t,e){return U*(6>n?d3.ascending(t.legs[n].split,e.legs[n].split):d3.ascending(t.totalTime,e.totalTime))}).transition().duration(500).delay(function(t,n){return 200*n/e.length}).call(r),q.selectAll(".split").transition().duration(500).style("fill-opacity",function(t,e){return n===e||6===n?"1":"0.25"}),O.classed("active",function(t){return t===n+1})},W(),F()}function L(){q.sort(function(t,e){return d3.descending(t.dist,e.dist)||d3.ascending(t.totalTime,e.totalTime)||d3.ascending(t.name,e.name)}).transition().duration(0).call(r)}function P(t){var e=!te.classed("dragging");te.classed("dragging",!0);var n=Z.invert(t);0>n&&(n=0),n>V&&(n=V),D.attr("cx",Z(n)),e&&q.selectAll(".split").transition().duration(500).style("fill-opacity",1),$.attr("cx",function(t){var e=d3.bisectLeft(t.cumulative,n),a=e-1;if(0>a)t.dist=0;else if(e>=h.length)t.dist=v;else{var r=(n-t.cumulative[a])/(t.cumulative[e]-t.cumulative[a]),i=d3.interpolate(h[a],h[e])(r);t.dist=i}d3.event&&(d3.event.stopPropagation(),d3.event.preventDefault())}),$.attr("cx",function(t){return B(t.dist)}),L()}function C(){var t=d3.mouse(j.node());P(t[0]),te.classed("playing")&&D.transition().duration(0).each("end",function(){te.classed("playing",!1)})}function E(){var t=d3.touches(j.node())[0];t[1]<0||t[1]>g?F():P(t[0]),te.classed("playing")&&D.transition().duration(0).each("end",function(){te.classed("playing",!1)})}function F(){D.transition().duration(0).each("end",function(){te.classed("dragging",!1).classed("playing",!1),W()})}function I(){D.transition().duration(0).each("end",function(){te.classed("playing",!1)})}function S(){return te.classed("playing",!0),D.transition().duration(5e3).ease("linear").attrTween("dummy",function(){return function(t){return P(N(t)),!1}}).each("end",function(){S().delay(1e3)})}setTimeout(function(){d3.select("body").classed("hidden",!1)});var V=d3.max(e,function(t){return t.totalTime}),Z=d3.scale.linear().domain([0,V]).rangeRound([0,o-u.right-f]).nice(15),N=d3.scale.linear().domain([0,1]).rangeRound([0,o-u.right-f]).nice(15),_=d3.svg.axis().scale(Z).orient("bottom").tickSize(5).tickPadding(12).tickFormat(a),j=A.append("g").attr("transform","translate("+u.left+","+u.top+")").attr("class","x axis").call(_);j.append("line").attr("x1",Z(0)).attr("x2",Z(V)).attr("y1",5).attr("y2",5);var D=j.append("circle").attr("class","ball").attr("cx",Z(0)).attr("cy",5).attr("r",s),G=e.map(t("name")),X=c*(1+G.length);x.attr("height",X+d.top+d.bottom);var Y=d3.scale.ordinal().domain(d3.range(G.length)).rangePoints([c,X]),q=b.selectAll("g.team").data(e,t("name")).enter().append("g").attr("class","team").call(r);q.append("rect").attr("width",o).attr("height",c).attr("y",-c+2).attr("rx",3).attr("ry",3).attr("fill","none"),q.append("text").text(t("name")).style("text-anchor","start");var B=d3.scale.linear().domain([0,h[6]]).nice(10).rangeRound([d.left+f,o-d.right]),H=d3.select("body").append("div").style("position","fixed").style("z-index","10").style("background-color","white").style("border","1px solid gray").style("padding","3px").style("visibility","hidden");q.selectAll(".split").data(function(t){return t.legs}).enter().append("text").attr("class","split").attr("x",function(t,e){return B(h[e])}).attr("dx",5).text(function(t){return n(t.split)}).on("mouseenter",k).on("mouseover",k).on("mousemove",function(){var t=d3.event.clientX,e=d3.event.clientY;return H.style("top",e+10+"px").style("left",t+15+"px").style("visibility","visible")}).on("mouseleave",l),q.append("text").attr("class","finish").attr("x",B(h[6])).attr("dx",5).text(function(t){return n(t.totalTime)});var J=d3.svg.axis().scale(B).orient("top").tickSize(0).tickFormat(i),K=y.append("g").attr("transform","translate(0,"+p+")").attr("class","x axis").call(J);b.call(T),y.call(T);var O=y.append("g").attr("class","legLabels").selectAll("rect").data(d3.range(1,8)).enter().append("rect").attr("width",38).attr("height",c).attr("x",function(t){return B(h[t-1])}).attr("y",3).attr("rx",3).attr("ry",3);y.append("g").selectAll("text").data(d3.range(1,8)).enter().append("text").attr("class","legname").text(function(t){return 7>t?"Leg "+t:"Finish"}).attr("y",15).attr("x",function(t){return B(h[t-1])}).attr("dx",4).style("text-anchor","start"),K.append("text").attr("y",-5).style("text-anchor","start").text("Team Name"),K.append("text").attr("y",-5).attr("x",o-10).style("text-anchor","end").text("miles"),R();var Q=h.length-1,U=1,W=R;d3.selectAll(".legname").on("click",z);var $=q.append("circle").attr("cx",B(0)).attr("cy",0).attr("r",3).attr("class","team-ball"),te=d3.select("body");w.on("click",S),M.on("click",F),A.on("mouseleave",F),A.on("mousemove",C),A.on("mouseenter",C),A.on("touchstart",E),A.on("touchmove",E),A.on("touchleave",F),d3.select("body").on("touchmove",F);var ee=d3.scale.category10();q.on("click",function(t){t.selected=!t.selected,d3.select(this).select("rect").attr("fill",t.selected?ee(t.name):"none")})})}();