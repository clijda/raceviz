!function(){"use strict";function t(t,e,a){R.append("circle").attr("class",t).attr("cx",e).attr("cy",p/2).attr("r",g),R.append("text").attr("x",e).attr("dx",8).attr("y",d/2+p/2-1).text(a)}function e(t){return t.split(":").map(Number).reduce(function(t,e){return 60*t+e})}function a(t){var e=60*t,a=Math.floor(e/3600),t=Math.floor(e/60-60*a),n=e%60;return a?a+"."+r(t)+"."+r(n):t+"."+r(n)}function n(t){var e=Math.floor(t/60),a=t%60;return e+":"+r(a)}function r(t){return t=Math.round(t),10>t?"0"+t:""+t}function l(t){if(!j[t]){var e=Math.round(((new Date).getTime()-m)/1e3);j[t]=!0,window.ga&&ga("send","event",t,e)}}function i(t){var a=e(t.time);return{name:t.name||[t.first,t.last].join(" "),place:+t.place,city:[t.city,t.state].join(", "),bib:+t.bib,age:+t.age,gender:t.gender,groupplace:t.groupplace,time:t.time,minutes:a/60,pace:t.pace||n(a/+c.miles),group:t.group,xoverall:+t.xoverall,yoverall:+t.yoverall,xag:+t.xag,yag:+t.yag}}var o,c=window.RACEVIZ||{},s={top:20,right:95,bottom:10,left:125},u=970-s.left-s.right,p=20,d=10,g=c.circleRadius||2,f=(c.padding||1,c.xThreshold||5,c.groupSpacing||70),y=c.overallYPosition||150,v=c.overallHeight||2*y,h=v+s.top+s.bottom,x="number"==typeof c.animationDuration?c.animationDuration:750,m=(new Date).getTime(),A="Overall",w=d3.scale.linear().range([0,u]),b=d3.select(".tip"),k=d3.scale.ordinal(),M=d3.scale.ordinal().domain([A]).range([y]),F=d3.svg.axis().scale(w).orient("top").tickFormat(a),T=d3.svg.axis().scale(k).orient("left").tickSize(-u,0).tickPadding(30),D=d3.select("#chart").append("svg").attr("height",h).attr("width",u+s.left+s.right).append("g").attr("transform","translate("+s.left+","+s.top+")"),R=d3.select("#legend").append("svg").attr("height",2*p).attr("width",u/2+s.left).append("g").attr("transform","translate("+s.left+",0)");R.append("text").attr("x",5).attr("y",2*d+p/2-1).text("Hover over a runner to view details"),t("F",0,"Female Finisher"),t("M",100,"Male Finisher"),d3.csv(c.datafile||"data.json",i,function(t){function e(t){t.attr("cx",function(t){return t[v].x}).attr("cy",function(t){return t[v].y})}function a(t){if(t){var e=t.split(",").map(function(t){return t.trim()}).filter(function(t){return t.length>0}).map(function(t){return"\\b"+d3.requote(t)}).join("|"),a=new RegExp("("+e+")","i");D.classed("searching",!0),P.classed("match",function(t){return a.test(t.name)||a.test(t.city)});var n=d3.selectAll(".match");1===n[0].length?p(n.datum()):d(),I.style("display",null)}else d(),D.classed("searching",!1),P.classed("match",!1),I.style("display","none")}function n(){return d(),"overall"===v?c():i(),l("transition"),!1}function r(t){function e(){}e.prototype=t;var a=new e,n=function(){return a};a.delay=n,a.transition=n,a.duration=n;var l=a.select,i=a.selectAll;return a.select=function(e){return r(l.call(t,e))},a.selectAll=function(e){return r(i.call(t,e))},a}function i(){b.style("display","none"),v="overall",d3.selectAll("button[data-view]").classed("active",function(t){return t===v});var t=10>x?N:d3.transition().duration(x);t.select("#chart svg").delay(72*x/75).attr("height",h),t.selectAll("#chart circle").delay(function(t){return x*t.overall.x/u}).attr("cx",function(t){return t.overall.x}).attr("cy",function(t){return t.overall.y}),t.select(".y.axis.overall").delay(x/3).style("stroke-opacity",1).style("fill-opacity",1),t.select(".y.axis.agegroup").style("stroke-opacity",0).style("fill-opacity",0)}function c(){b.style("display","none"),v="ag",d3.selectAll("button[data-view]").classed("active",function(t){return t===v});var t=10>x?N:d3.transition().duration(x);t.select("#chart svg").attr("height",o+s.top+s.bottom).transition().delay(72*x/75),t.selectAll("#chart circle").delay(function(t){return x*t.ag.x/u}).attr("cx",function(t){return t.ag.x}).attr("cy",function(t){return t.ag.y}),t.select(".y.axis.overall").style("stroke-opacity",0).style("fill-opacity",0),t.select(".y.axis.agegroup").delay(x/3).style("stroke-opacity",1).style("fill-opacity",1)}function p(e){if(!e.mouseover){d(),e.mouseover=!0,P.filter(function(t){return t===e}).classed("active",!0).attr("r",g).each(function(){this.parentNode.appendChild(this)});var a,n;"overall"===v?(a=e.xoverall,n=e.overall.y):(a=e.xag,n=e.ag.y),b.style("display",null).style("top",n+s.top-+b.style("height").replace("px","")-5+"px").style("left",a+s.left-+b.style("width").replace("px","")-5+"px"),b.selectAll(".name").text(e.name),b.selectAll(".age").text(e.age),b.selectAll(".gender").text(e.gender),b.selectAll(".city").text(e.city),b.selectAll(".time").text(e.time),b.selectAll(".place").text(e.place),b.selectAll(".pace").text(e.pace.split("/")[0]+"/mi"),b.selectAll(".total").text(t.length),"***"===e.groupplace?b.selectAll(".agplace").text("Top "+("M"===e.gender?"male":"female")+" finisher"):b.selectAll(".agplace").text(e.groupplace+"/"+R[e.gender+e.group]+" in "+e.gender+e.group),l("mouseover")}}function d(){b.style("display","none"),P.filter(".active").classed("active",!1).attr("r",g).each(function(t){t.mouseover=!1})}function y(){var t=window.location.hash,e=decodeURI(t.substr(1).replace(/(\+)/g," "));t.indexOf("agegroup")>-1?(e=e.replace(/(agegroup[\s\\,]*|[\s\\,]*agegroup)/,""),c(),setTimeout(a,750,e)):(i(),a(e)),C.property("value",e)}var v="overall",m=d3.nest().key(function(t){return t.group}).sortKeys(function(t,e){return d3.ascending(t.slice(0,2),e.slice(0,2))}).entries(t),A=m.map(function(t){return t.key}),R={};d3.nest().key(function(t){return t.gender+t.group}).entries(t).forEach(function(t){R[t.key]=t.values.length}),o=f*A.length,w.domain(d3.extent(t,function(t){return t.minutes})),F.tickValues(w.domain().concat(w.ticks().slice(1,w.ticks().length-1))),k.domain(A).rangePoints([10,o],1);var j=D.append("g").attr("class","x axis").call(F),E=j.append("text").attr("y",-5).style("text-anchor","end");E.append("tspan").attr("x",-25).style("font-weight","bold").text("Net Finish Time"),D.append("g").attr("class","y axis agegroup").call(T.scale(k)).style("stroke-opacity",0).style("fill-opacity",0),D.append("g").attr("class","y axis overall").call(T.scale(M)),t.forEach(function(t){t.overall={x0:w(t.minutes),y0:M(t.group),x:t.xoverall||w(t.minutes),y:t.yoverall+M(t.group)||M(t.group),r:g},t.ag={x0:w(t.minutes),y0:k(t.group),x:t.xag||w(t.minutes),y:t.yag+k(t.group)||k(t.group),r:g}});var P=D.append("g").attr("class","results").selectAll("circle").data(t).enter().append("circle").attr("r",d3.functor(g)).attr("cx",function(t){return t.overall.x}).attr("cy",function(t){return t.overall.y}).attr("class",function(t){return t.gender}).on("mouseleave",d).on("mouseout",d).on("mouseover",p);b.on("mouseover",d),P.call(e);var C=d3.select(".search input").on("keyup",function(){27===d3.event.keyCode&&(this.value="",this.blur()),a(this.value.trim()),l("search")});d3.selectAll(".search .caption a").datum(function(){return decodeURI(this.getAttribute("href").substr(1)).replace(/\+/g," ")}).on("click",function(t){C.property("value",t),a(t),d3.event.stopPropagation(),d3.event.preventDefault()});var I=d3.select(".search .search-clear").on("click",function(){C.property("value","").node().blur(),a()});d3.selectAll("button[data-view]").datum(function(){return this.getAttribute("data-view")}).on("click",n);var N=r(d3);y(),window.onhashchange=y});var j={}}();