!function(){"use strict";function t(t,e,a){A.append("circle").attr("class",t).attr("cx",e).attr("cy",s/2).attr("r",p),A.append("text").attr("x",e).attr("dx",8).attr("y",u/2+s/2-1).text(a)}function e(t){return t.split(":").map(Number).reduce(function(t,e){return 60*t+e})}function a(t){return Math.floor(t)+":00"}function r(t){var a=e(t.time);return{name:t.name||[t.first,t.last].join(" "),place:+t.place,city:[t.city,t.state].join(", "),bib:+t.bib,age:+t.age,gender:t.gender,groupplace:t.groupplace,time:t.time,minutes:a/60,pace:t.pace,group:t.group,xoverall:+t.xoverall,yoverall:+t.yoverall,xag:+t.xag,yag:+t.yag}}var l,n=window.RACEVIZ||{},c={top:20,right:95,bottom:10,left:125},i=970-c.left-c.right,o=300+c.top+c.bottom,s=20,u=10,p=n.circleRadius||2;n.padding||1;var d="Overall",g=d3.scale.linear().rangeRound([0,i]),y=d3.select(".tip"),f=d3.scale.ordinal(),v=d3.scale.ordinal().domain([d]).range([150]),x=d3.svg.axis().scale(g).orient("top").tickFormat(a),h=d3.svg.axis().scale(f).orient("left").tickSize(-i,0).tickPadding(30),m=d3.select("#chart").append("svg").attr("height",o).attr("width",i+c.left+c.right).append("g").attr("transform","translate("+c.left+","+c.top+")"),A=d3.select("#legend").append("svg").attr("height",2*s).attr("width",i/2+c.left).append("g").attr("transform","translate("+c.left+",0)");A.append("text").attr("x",5).attr("y",2*u+s/2-1).text("Hover over a runner to view details"),t("F",0,"Female Finisher"),t("M",100,"Male Finisher"),d3.csv(n.datafile||"data.csv",r,function(t){function e(t){t.attr("cx",function(t){return t[A].x}).attr("cy",function(t){return t[A].y})}function a(t){if(t){var e=t.split(",").map(function(t){return t.trim()}).filter(function(t){return t.length>0}).map(function(t){return"\\b"+d3.requote(t)}).join("|"),a=new RegExp("("+e+")","i");m.classed("searching",!0),E.classed("match",function(t){return a.test(t.name)||a.test(t.city)});var r=d3.selectAll(".match");1===r[0].length?s(r.datum()):u(),j.style("display",null)}else u(),m.classed("searching",!1),E.classed("match",!1),j.style("display","none")}function r(){return u(),"overall"===A?i():n(),!1}function n(){y.style("display","none"),A="overall",d3.selectAll("button[data-view]").classed("active",function(t){return t===A});var t=d3.transition().duration(750);t.select("#chart svg").delay(720).attr("height",o),t.selectAll("#chart circle").delay(function(t){return t.overall.x}).attr("cx",function(t){return t.overall.x}).attr("cy",function(t){return t.overall.y}),t.select(".y.axis.overall").delay(250).style("stroke-opacity",1).style("fill-opacity",1),t.select(".y.axis.agegroup").style("stroke-opacity",0).style("fill-opacity",0)}function i(){y.style("display","none"),A="ag",d3.selectAll("button[data-view]").classed("active",function(t){return t===A});var t=d3.transition().duration(750);t.select("#chart svg").attr("height",l+c.top+c.bottom).transition().delay(720),t.selectAll("#chart circle").delay(function(t){return t.ag.x}).attr("cx",function(t){return t.ag.x}).attr("cy",function(t){return t.ag.y}),t.select(".y.axis.overall").style("stroke-opacity",0).style("fill-opacity",0),t.select(".y.axis.agegroup").delay(250).style("stroke-opacity",1).style("fill-opacity",1)}function s(e){if(!e.mouseover){u(),e.mouseover=!0,E.filter(function(t){return t===e}).classed("active",!0).attr("r",p).each(function(){this.parentNode.appendChild(this)});var a,r;"overall"===A?(a=e.xoverall,r=e.overall.y):(a=e.xag,r=e.ag.y),y.style("display",null).style("top",r+c.top-+y.style("height").replace("px","")-5+"px").style("left",a+c.left-+y.style("width").replace("px","")-5+"px"),y.selectAll(".name").text(e.name),y.selectAll(".age").text(e.age),y.selectAll(".gender").text(e.gender),y.selectAll(".city").text(e.city),y.selectAll(".time").text(e.time),y.selectAll(".place").text(e.place),y.selectAll(".pace").text(e.pace),y.selectAll(".total").text(t.length),"***"===e.groupplace?y.selectAll(".agplace").text("Top "+("M"===e.gender?"male":"female")+" finisher"):y.selectAll(".agplace").text(e.groupplace+"/"+w[e.gender+e.group]+" in "+e.gender+e.group)}}function u(){y.style("display","none"),E.filter(".active").classed("active",!1).attr("r",p).each(function(t){t.mouseover=!1})}function d(){var t=window.location.hash,e=decodeURI(t.substr(1).replace(/(\+)/g," "));t.indexOf("agegroup")>-1?(e=e.replace(/(agegroup[\s\\,]*|[\s\\,]*agegroup)/,""),i(),setTimeout(a,750,e)):(n(),a(e)),M.property("value",e)}var A="overall",b=d3.nest().key(function(t){return t.group}).sortKeys(function(t,e){return d3.ascending(t.slice(0,2),e.slice(0,2))}).entries(t),k=b.map(function(t){return t.key}),w={};d3.nest().key(function(t){return t.gender+t.group}).entries(t).forEach(function(t){w[t.key]=t.values.length}),l=70*k.length,g.domain(d3.extent(t,function(t){return t.minutes})).nice(10),f.domain(k).rangePoints([10,l],1);var F=m.append("g").attr("class","x axis").call(x),R=F.append("text").attr("y",-5).style("text-anchor","end");R.append("tspan").attr("x",-25).style("font-weight","bold").text("Net Finish Time"),m.append("g").attr("class","y axis agegroup").call(h.scale(f)).style("stroke-opacity",0).style("fill-opacity",0),m.append("g").attr("class","y axis overall").call(h.scale(v)),t.forEach(function(t){t.overall={x0:g(t.minutes),y0:v(t.group),x:t.xoverall||g(t.minutes),y:t.yoverall+v(t.group)||v(t.group),r:p},t.ag={x0:g(t.minutes),y0:f(t.group),x:t.xag||g(t.minutes),y:t.yag+f(t.group)||f(t.group),r:p}});var E=m.append("g").attr("class","results").selectAll("circle").data(t).enter().append("circle").attr("r",d3.functor(p)).attr("cx",function(t){return t.overall.x}).attr("cy",function(t){return t.overall.y}).attr("class",function(t){return t.gender}).on("mouseleave",u).on("mouseout",u).on("mouseover",s);y.on("mouseover",u),E.call(e);var M=d3.select(".search input").on("keyup",function(){27===d3.event.keyCode&&(this.value="",this.blur()),a(this.value.trim())});d3.selectAll(".search .caption a").datum(function(){return decodeURI(this.getAttribute("href").substr(1)).replace(/\+/g," ")}).on("click",function(t){M.property("value",t),a(t),d3.event.stopPropagation(),d3.event.preventDefault()});var j=d3.select(".search .search-clear").on("click",function(){M.property("value","").node().blur(),a()});d3.selectAll("button[data-view]").datum(function(){return this.getAttribute("data-view")}).on("click",r),d(),window.onhashchange=d})}();